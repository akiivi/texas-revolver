<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éª—å­é…’é¦†å¾·å·æ¨¡å¼ï¼ˆå·¦è½®ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#111418;--panel:#1b1f24;--accent:#ffcc00;--ok:#ff4d4d;--warn:#ff9800;--muted:#b5bdc9;
    }
    *{box-sizing:border-box}
    body{
      margin:0; 
      background: radial-gradient(circle at center, #222 0%, #000 100%);
      color:#fff;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      min-height:100vh; 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      justify-content:flex-start;
      overflow: hidden;
    }
    
    h1{
      margin: 40px 0 20px; 
      font-size: 28px; 
      color: #ffcc00;
      text-shadow: 2px 2px 8px #000;
    }

    .board{
      width: min(92vw, 860px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    /* å·¦è½®ä¸»ä½“ - ä¿®å¤æ—‹è½¬ä¸­å¿ƒé—®é¢˜ */
    .revolver-container {
      position: relative;
      width: 360px;
      height: 360px;
    }
    .revolver{
      position:relative; 
      width:360px; 
      height:360px; 
      border-radius:50%;
      background: radial-gradient(circle at 35% 35%, #6b6f76, #343a40 55%, #23272e 80%);
      border:6px solid #0d0f12; 
      box-shadow: inset 0 0 40px rgba(0,0,0,.6), 0 12px 40px rgba(0,0,0,.45);
    }
    .cylinder{
      position:absolute; 
      left: 30px;
      top: 30px;
      width: 300px;
      height: 300px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #9aa3ad, #606770 55%, #3b4048 85%);
      border:8px solid #0f1216; 
      box-shadow: inset 0 0 18px rgba(0,0,0,.7);
      transition: transform 1.1s cubic-bezier(.2,.8,.2,1);
      transform: rotate(0deg);
      transform-origin: 50% 50%; /* æ˜ç¡®æ—‹è½¬ä¸­å¿ƒ */
    }
    .pivot{
      position:absolute; 
      left:50%; 
      top:50%; 
      transform:translate(-50%, -50%);
      width:28px; 
      height:28px; 
      border-radius:50%; 
      background: radial-gradient(circle at 35% 35%, #f2f2f2, #8e8e8e);
      border:4px solid #0b0d0f; 
      box-shadow: inset 0 0 6px rgba(0,0,0,.6);
      z-index:4;
    }
    .muzzle-indicator{
      position:absolute; 
      left:50%; 
      top:6px; 
      transform:translateX(-50%);
      width:10px; 
      height:22px; 
      border-radius:6px; 
      background:#d3d7df; 
      border:2px solid #0b0d0f; 
      box-shadow:0 0 6px rgba(0,0,0,.6);
      z-index:3;
    }

    /* 8ä¸ªå¼¹ä»“å­”ä½ - ç²¾ç¡®è®¡ç®—ä½ç½® */
    .chamber{
      position:absolute; 
      left: 50%;
      top: 50%;
      width:68px; 
      height:68px; 
      margin: -34px; /* å±…ä¸­è‡ªèº« */
      border-radius:50%;
      background: radial-gradient(circle at 40% 40%, #2b2f36, #15181d 60%);
      border:4px solid #0b0e12; 
      box-shadow: inset 0 10px 18px rgba(0,0,0,.7);
      display:flex; 
      align-items:center; 
      justify-content:center;
    }
    /* å¼¹ä»“ä½ç½®ï¼ˆåœ†å‘¨åˆ†å¸ƒï¼‰ */
    .chamber[data-i="0"]{ transform: translate(-50%, -50%) translateY(-105px); }
    .chamber[data-i="1"]{ transform: translate(-50%, -50%) rotate(45deg) translateY(-105px) rotate(-45deg); }
    .chamber[data-i="2"]{ transform: translate(-50%, -50%) rotate(90deg) translateY(-105px) rotate(-90deg); }
    .chamber[data-i="3"]{ transform: translate(-50%, -50%) rotate(135deg) translateY(-105px) rotate(-135deg); }
    .chamber[data-i="4"]{ transform: translate(-50%, -50%) rotate(180deg) translateY(-105px) rotate(-180deg); }
    .chamber[data-i="5"]{ transform: translate(-50%, -50%) rotate(225deg) translateY(-105px) rotate(-225deg); }
    .chamber[data-i="6"]{ transform: translate(-50%, -50%) rotate(270deg) translateY(-105px) rotate(-270deg); }
    .chamber[data-i="7"]{ transform: translate(-50%, -50%) rotate(315deg) translateY(-105px) rotate(-315deg); }

    .bullet{
      width:30px; 
      height:30px; 
      border-radius:50%;
      background: radial-gradient(circle at 35% 35%, #ffd479, #cc9a2f 55%, #8f5b13);
      border:3px solid #5a3b0d; 
      box-shadow: inset 0 6px 10px rgba(0,0,0,.45);
      transform: scale(0.95);
    }
    .bullet.none{display:none}

    .pointer{
      position:absolute; 
      top:-24px; 
      left:50%; 
      transform: translateX(-50%);
      width:0; 
      height:0; 
      border-left:12px solid transparent; 
      border-right:12px solid transparent; 
      border-bottom:18px solid #ffcc00;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.5)); 
      z-index:4;
    }

    .tray {
      display: flex;
      justify-content: center;
      margin: 20px;
      min-height: 60px;
    }
    .tray-bullet {
      width: 20px;
      height: 40px;
      background: gold;
      border-radius: 5px;
      margin: 0 3px;
      box-shadow: 0 0 8px #ff0;
      animation: drop 0.3s ease-out;
    }
    @keyframes drop {
      from {transform: translateY(-50px); opacity: 0;}
      to {transform: translateY(0); opacity: 1;}
    }

    .controls {
      margin: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .btn{
      background:#2b3139; 
      border:1px solid #3b424c; 
      color:#e9eef6; 
      padding:10px 14px; 
      border-radius:10px; 
      font-size:15px; 
      cursor:pointer; 
      transition:.2s ease; 
      user-select:none;
      box-shadow:0 2px 0 rgba(0,0,0,.35);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:#dc3545; border-color:#e0525f}
    .btn.success{background:#2e9b57; border-color:#39b56b}
    .btn.info{background:#1f6feb; border-color:#2b7df1}
    .btn.warn{background:#6c757d; border-color:#7b8a93}

    .message {
      font-size: 24px;
      margin: 20px;
      font-weight: bold;
      text-shadow: 2px 2px 8px #000;
      min-height: 30px;
    }

    .top-right {
      position: fixed;
      top: 10px;
      right: 10px;
    }

    /* æ·»åŠ å·¦ä¸‹è§’æ ‡è¯†æ ·å¼ */
    .bottom-left {
      position: fixed;
      bottom: 10px;
      left: 10px;
      color: var(--muted);
      font-size: 14px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      opacity: 0.8;
    }

    /* å¼ºåŒ–å±å¹•é—ªçƒæ•ˆæœ */
    .flash{ 
      position:fixed; 
      inset:0; 
      background:transparent; 
      pointer-events:none; 
      opacity:0; 
      z-index:999; 
      transition: opacity 0.1s;
    }
    .flash.fire{ 
      background:rgba(255,0,0,.7); 
      animation:flash 0.3s ease; 
    }
    .flash.jam{ 
      background:rgba(255,153,0,.8); 
      animation:flash 0.6s ease 2; 
    }
    .flash.empty{ 
      background:rgba(200,200,200,0.6); 
      animation:flash 0.3s ease; 
    }
    @keyframes flash{ 
      0%, 100% {opacity:0;}
      50% {opacity:1;}
    }

    /* è£…å¡«é£å…¥åŠ¨ç”» */
    .fly-bullet{
      position:fixed; 
      width:18px; 
      height:18px; 
      border-radius:50%; 
      background:radial-gradient(circle at 35% 35%, #ffd479, #cc9a2f 55%, #8f5b13);
      border:2px solid #5a3b0d; 
      box-shadow:0 4px 8px rgba(0,0,0,.45);
      left:50%; 
      bottom:10%; 
      transform:translateX(-50%) scale(1); 
      opacity:.9; 
      z-index:30;
      transition: transform .6s cubic-bezier(.2,.8,.2,1), left .6s cubic-bezier(.2,.8,.2,1), top .6s cubic-bezier(.2,.8,.2,1), opacity .6s;
    }

    /* é€€å¼¹é£å‡ºåŠ¨ç”» */
    .eject-bullet{
      position:absolute; 
      width:16px; 
      height:16px; 
      border-radius:50%; 
      background:radial-gradient(circle at 35% 35%, #ffd479, #cc9a2f 55%, #8f5b13);
      border:2px solid #5a3b0d; 
      filter:brightness(.95); 
      z-index:40; 
      opacity:1;
      animation:eject .7s ease forwards;
    }
    @keyframes eject{
      0%{ transform:translate(0,0) scale(1); opacity:1}
      100%{ transform:translate(0,140px) scale(.8); opacity:0}
    }

    /* ç¦ç”¨æ€ */
    .btn[disabled]{opacity:.5; cursor:not-allowed}
  </style>
</head>
<body>
  <h1>éª—å­é…’é¦†å¾·å·æ¨¡å¼ï¼ˆå·¦è½®ç‰ˆï¼‰</h1>
  
  <div class="board">
    <div class="revolver-container">
      <div class="revolver" id="revolver">
        <div class="muzzle-indicator"></div>
        <div class="pointer"></div>
        <div class="cylinder" id="cylinder">
          <div class="pivot"></div>
          <!-- 8 ä¸ªå¼¹ä»“å­”ä½ä¸å­å¼¹å ä½ -->
          <div class="chamber" data-i="0"><div class="bullet none" data-bullet="0"></div></div>
          <div class="chamber" data-i="1"><div class="bullet none" data-bullet="1"></div></div>
          <div class="chamber" data-i="2"><div class="bullet none" data-bullet="2"></div></div>
          <div class="chamber" data-i="3"><div class="bullet none" data-bullet="3"></div></div>
          <div class="chamber" data-i="4"><div class="bullet none" data-bullet="4"></div></div>
          <div class="chamber" data-i="5"><div class="bullet none" data-bullet="5"></div></div>
          <div class="chamber" data-i="6"><div class="bullet none" data-bullet="6"></div></div>
          <div class="chamber" data-i="7"><div class="bullet none" data-bullet="7"></div></div>
        </div>
      </div>
    </div>

    <div class="tray" id="tray"></div>
    
    <div class="controls">
      <button class="btn success" onclick="addBullet()">â• æ·»åŠ å­å¼¹</button>
      <button class="btn primary" onclick="shoot()">ğŸ”« å¼€æª</button>
      <button class="btn info" onclick="removeBullets()">â é€€å¼¹</button>
      <button class="btn warn" onclick="allIn()">All in</button>
    </div>
    
    <div class="message" id="message"></div>
  </div>

  <div class="top-right">
    <button class="btn warn" onclick="restart()">ğŸ”„ é‡æ–°å¼€å§‹</button>
  </div>

  <!-- å·¦ä¸‹è§’æ·»åŠ åˆ¶ä½œæ ‡è¯† -->
  <div class="bottom-left">æ¸…æ¬¢.åˆ¶ä½œ</div>

  <!-- å±å¹•é—ªçƒå±‚ -->
  <div id="flash" class="flash"></div>

  <script>
    // â€”â€” æ•°æ®çŠ¶æ€ â€”â€”
    const CHAMBERS = 8;
    let bullets = 0; // å½“å‰å­å¼¹æ•°é‡
    let chambers = new Array(CHAMBERS).fill(false); // æ¯æ ¼æ˜¯å¦æœ‰å­å¼¹
    let currentIndex = 0; // æŒ‡å‘æªå£çš„æ ¼ä½ï¼ˆ0 é¡¶éƒ¨ï¼‰
    let currentRotation = 0; // å®é™…æ—‹è½¬è§’åº¦ç´¯è®¡
    let locking = false; // é˜²æ­¢è¿ç»­æ“ä½œ

    // â€”â€” DOM å¼•ç”¨ â€”â€”
    const cylinder = document.getElementById('cylinder');
    const tray = document.getElementById('tray');
    const message = document.getElementById('message');
    const flashEl = document.getElementById('flash');

    // â€”â€” Web Audio å£°éŸ³åˆæˆ â€”â€”
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioCtx();

    // è£…å¼¹éŸ³æ•ˆ - æ™®é€šæ·»åŠ å­å¼¹
    function playLoad() {
      // é‡‘å±æ»‘å—å£°
      const slider = audioCtx.createOscillator();
      const sliderGain = audioCtx.createGain();
      slider.type = 'sine';
      slider.frequency.setValueAtTime(550, audioCtx.currentTime);
      slider.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.25);
      
      sliderGain.gain.setValueAtTime(0.001, audioCtx.currentTime);
      sliderGain.gain.exponentialRampToValueAtTime(0.25, audioCtx.currentTime + 0.03);
      sliderGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
      
      slider.connect(sliderGain).connect(audioCtx.destination);
      slider.start();
      slider.stop(audioCtx.currentTime + 0.35);
      
      // å­å¼¹å…¥è†›å£°
      setTimeout(() => {
        const click = audioCtx.createOscillator();
        const clickGain = audioCtx.createGain();
        click.type = 'impact';
        click.frequency.value = 1100;
        
        clickGain.gain.setValueAtTime(0.001, audioCtx.currentTime);
        clickGain.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);
        clickGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.07);
        
        click.connect(clickGain).connect(audioCtx.destination);
        click.start();
        click.stop(audioCtx.currentTime + 0.08);
      }, 200);
    }

    // All in ä¸“ç”¨éŸ³æ•ˆ - æ›´ä¸¥è‚ƒã€æ²‰é‡çš„å£°éŸ³
    function playAllInSound() {
      // ä½æ²‰çš„é‡‘å±æ’å‡»å£°
      const baseOsc = audioCtx.createOscillator();
      const baseGain = audioCtx.createGain();
      baseOsc.type = 'sine';
      baseOsc.frequency.setValueAtTime(180, audioCtx.currentTime);
      baseOsc.frequency.exponentialRampToValueAtTime(120, audioCtx.currentTime + 0.5);
      
      baseGain.gain.setValueAtTime(0.001, audioCtx.currentTime);
      baseGain.gain.exponentialRampToValueAtTime(0.5, audioCtx.currentTime + 0.1);
      baseGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.6);
      
      baseOsc.connect(baseGain).connect(audioCtx.destination);
      baseOsc.start();
      baseOsc.stop(audioCtx.currentTime + 0.7);
      
      // è¿ç»­è£…å¼¹çš„æœºæ¢°å£°
      setTimeout(() => {
        const mechanicalOsc = audioCtx.createOscillator();
        const mechanicalGain = audioCtx.createGain();
        mechanicalOsc.type = 'square';
        mechanicalOsc.frequency.value = 400;
        
        mechanicalGain.gain.setValueAtTime(0.001, audioCtx.currentTime + 0.2);
        mechanicalGain.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime + 0.25);
        mechanicalGain.gain.setTargetAtTime(0.001, audioCtx.currentTime + 0.3, 0.1);
        
        mechanicalOsc.connect(mechanicalGain).connect(audioCtx.destination);
        mechanicalOsc.start(audioCtx.currentTime + 0.2);
        mechanicalOsc.stop(audioCtx.currentTime + 0.5);
      }, 200);
    }

    function playClick(){ // ç©ºæªâ€œå’”å“’â€
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'square'; o.frequency.value = 850;
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.06);
      o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.07);
    }

    function playGunshot(){ // æªå£°
      // å™ªå£°ç¼“å†²
      const bufferSize = 0.25 * audioCtx.sampleRate;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++){ data[i] = (Math.random()*2-1) * (1 - i/bufferSize); }
      const src = audioCtx.createBufferSource(); src.buffer = buffer;
      const filter = audioCtx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value = 1800;
      const g = audioCtx.createGain(); g.gain.setValueAtTime(0.8, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.22);
      src.connect(filter).connect(g).connect(audioCtx.destination);
      src.start(); src.stop(audioCtx.currentTime + 0.23);
      
      // æªå£å†²å‡»å£°
      const o = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
      o.type='triangle'; o.frequency.setValueAtTime(120, audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(60, audioCtx.currentTime + 0.08);
      g2.gain.setValueAtTime(0.6, audioCtx.currentTime); g2.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.12);
      o.connect(g2).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.13);
    }

    // å¡å¼¹éŸ³æ•ˆ
    function playJam(){ 
      // é‡‘å±æ‘©æ“¦å£°
      const jam1 = audioCtx.createOscillator();
      const jam1Gain = audioCtx.createGain();
      jam1.type = 'sawtooth';
      jam1.frequency.setValueAtTime(800, audioCtx.currentTime);
      jam1.frequency.exponentialRampToValueAtTime(250, audioCtx.currentTime + 0.3);
      
      jam1Gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
      jam1Gain.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime + 0.05);
      jam1Gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
      
      jam1.connect(jam1Gain).connect(audioCtx.destination);
      jam1.start();
      jam1.stop(audioCtx.currentTime + 0.45);
      
      // æœºæ¢°å¡æ»å£°
      setTimeout(() => {
        const jam2 = audioCtx.createOscillator();
        const jam2Gain = audioCtx.createGain();
        jam2.type = 'square';
        jam2.frequency.value = 350;
        
        jam2Gain.gain.setValueAtTime(0.3, audioCtx.currentTime + 0.2);
        jam2Gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
        
        jam2.connect(jam2Gain).connect(audioCtx.destination);
        jam2.start(audioCtx.currentTime + 0.2);
        jam2.stop(audioCtx.currentTime + 0.5);
      }, 200);
    }

    function playEject(){ // é€€å¼¹éŸ³æ•ˆ
      const ping = (t0, f)=>{
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type='sine'; o.frequency.setValueAtTime(f, t0);
        g.gain.setValueAtTime(0.0001, t0); g.gain.exponentialRampToValueAtTime(0.35, t0+0.01);
        g.gain.exponentialRampToValueAtTime(0.001, t0+0.25);
        o.connect(g).connect(audioCtx.destination); o.start(t0); o.stop(t0+0.26);
      };
      const t = audioCtx.currentTime;
      ping(t, 1600); ping(t+0.12, 1200);
    }

    function showMessage(text, color) {
      message.textContent = text;
      message.style.color = color;
    }

    // è®¡ç®—å¼¹ä»“ä½ç½®
    function getChamberCenter(index){
      const cylRect = cylinder.getBoundingClientRect();
      const centerX = cylRect.left + cylRect.width/2;
      const centerY = cylRect.top + cylRect.height/2;
      const radius = 105;
      const angleRad = (index * 45 - 90) * Math.PI/180;
      const x = centerX + radius * Math.cos(angleRad);
      const y = centerY + radius * Math.sin(angleRad);
      return {x,y};
    }

    // è£…å¡«å­å¼¹åŠ¨ç”»
    function animateLoadTo(index){
      const {x, y} = getChamberCenter(index);
      const el = document.createElement('div'); el.className = 'fly-bullet';
      document.body.appendChild(el);
      
      requestAnimationFrame(()=>{
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.style.transform = 'translate(-50%, -50%) scale(0.9)';
        el.style.opacity = '1';
      });
      
      setTimeout(()=>{ el.remove(); }, 650);
    }

    // é€€å¼¹åŠ¨ç”»
    function animateEjectAll(){
      chambers.forEach((hasBullet, i)=>{
        if(!hasBullet) return;
        const {x,y} = getChamberCenter(i);
        const el = document.createElement('div'); el.className='eject-bullet';
        el.style.left = (x-8) + 'px';
        el.style.top = (y-8) + 'px';
        document.body.appendChild(el);
        setTimeout(()=> el.remove(), 800);
      });
    }

    // å±å¹•é—ªçƒ - å¢å¼ºæ•ˆæœ
    function flash(type){
      flashEl.className = 'flash ' + type;
      // å¢å¼ºé—ªçƒæ•ˆæœï¼šæ·»åŠ è½»å¾®çš„éœ‡åŠ¨
      if (type === 'fire') {
        document.body.style.transition = 'transform 0.05s';
        document.body.style.transform = 'translateY(2px)';
        setTimeout(() => {
          document.body.style.transform = 'translateY(-2px)';
          setTimeout(() => {
            document.body.style.transform = 'translateY(0)';
          }, 50);
        }, 50);
      }
      setTimeout(()=>{ flashEl.className = 'flash'; }, type === 'jam' ? 1200 : 300);
    }

    // æ—‹è½¬å¼¹å¤¹åˆ°ç›®æ ‡ä½ç½®
    function rotateToIndex(targetIndex){
      const diff = ((targetIndex - currentIndex) % CHAMBERS + CHAMBERS) % CHAMBERS;
      const baseDeg = diff * 45;
      const extraSpins = 2 + Math.floor(Math.random() * 2); // 2-3åœˆéšæœºæ—‹è½¬
      const delta = extraSpins * 360 + baseDeg;
      currentRotation += delta;
      
      cylinder.style.transition = 'transform 1.2s cubic-bezier(.25,.46,.45,.94)';
      cylinder.style.transform = `rotate(${currentRotation}deg)`;
      currentIndex = targetIndex;
      
      return 1200; // åŠ¨ç”»æ—¶é•¿(ms)
    }

    // æ›´æ–°å­å¼¹æ˜¾ç¤º
    function renderBullets(){
      for(let i=0;i<CHAMBERS;i++){
        const bulletEl = document.querySelector(`.bullet[data-bullet="${i}"]`);
        if(chambers[i]){ 
          bulletEl.classList.remove('none'); 
        } else { 
          bulletEl.classList.add('none'); 
        }
      }
    }

    // æ·»åŠ å­å¼¹
    function addBullet() {
      if (bullets >= CHAMBERS) {
        showMessage('å¼¹ä»“å·²æ»¡ï¼ˆ8/8ï¼‰', 'orange');
        return;
      }
      
      const empty = [];
      chambers.forEach((v,i)=>{ if(!v) empty.push(i); });
      const idx = empty[Math.floor(Math.random()*empty.length)];
      chambers[idx] = true;
      bullets++;
      
      // æ’­æ”¾æ™®é€šè£…å¼¹éŸ³æ•ˆ
      playLoad();
      
      renderBullets();
      animateLoadTo(idx);
      
      const b = document.createElement('div');
      b.className = 'tray-bullet';
      tray.appendChild(b);
      
      showMessage(`å·²æ·»åŠ  ${bullets} é¢—å­å¼¹`, '#ffcc00');
    }

    // å…¨éƒ¨è£…æ»¡ - ä½¿ç”¨ä¸¥è‚ƒéŸ³æ•ˆ
    function allIn() {
      if (bullets === CHAMBERS) {
        showMessage('å·²ç»è£…æ»¡å­å¼¹äº†ï¼', 'orange');
        return;
      }
      
      // æ¸…ç©ºç°æœ‰å­å¼¹
      removeBullets(false);
      
      // å»¶è¿Ÿåå¡«æ»¡æ‰€æœ‰å­å¼¹ï¼Œä½¿ç”¨ä¸¥è‚ƒçš„All inéŸ³æ•ˆ
      setTimeout(() => {
        playAllInSound(); // æ’­æ”¾All inä¸“ç”¨éŸ³æ•ˆ
        
        bullets = 0; // é‡ç½®è®¡æ•°
        for (let i = 0; i < CHAMBERS; i++) {
          chambers[i] = true;
          bullets++;
          
          const b = document.createElement('div');
          b.className = 'tray-bullet';
          tray.appendChild(b);
          
          // è¿ç»­è£…å¼¹çš„è§†è§‰åé¦ˆ
          setTimeout(() => {
            renderBullets();
            animateLoadTo(i);
          }, i * 100);
        }
        
        showMessage('å·²å¡«æ»¡æ‰€æœ‰å­å¼¹ï¼', '#ffcc00');
      }, 500);
    }

    // é€€å¼¹
    function removeBullets(showMsg = true) {
      if (bullets === 0) {
        if (showMsg) showMessage('æ— å­å¼¹å¯é€€', 'orange');
        return;
      }
      
      animateEjectAll();
      playEject();
      
      setTimeout(() => {
        bullets = 0;
        chambers.fill(false);
        renderBullets();
        tray.innerHTML = '';
        if (showMsg) showMessage('å­å¼¹å·²é€€ç©º', 'orange');
      }, 120);
    }

    // å¼€æª
    function shoot() {
      if (locking) return;
      if (bullets === 0) {
        playClick();
        showMessage('ç©ºæªï¼æ²¡æœ‰å­å¼¹', 'orange');
        flash('empty');
        return;
      }
      
      locking = true;
      showMessage('æ—‹è½¬ä¸­...', '#ffcc00');
      
      const target = Math.floor(Math.random() * CHAMBERS);
      const dur = rotateToIndex(target);
      
      setTimeout(() => {
        // 8% å¡å¼¹æ¦‚ç‡
        const jamProbability = 0.08;
        if (Math.random() < jamProbability) {
          playJam();
          flash('jam');
          showMessage('å¡å¼¹äº†ï¼å¹¸è¿çš„ä¸€æ¬¡ï¼', '#ff9800');
          locking = false;
          return;
        }
        
        const hasBullet = chambers[currentIndex];
        
        if (hasBullet) {
          playGunshot();
          flash('fire'); // å¢å¼ºçš„é—ªçƒæ•ˆæœ
          showMessage('å‡»å‘æˆåŠŸï¼ç °ï¼ï¼ï¼', 'red');
        } else {
          playClick();
          flash('empty');
          showMessage('ç©ºæª...å¹¸å­˜ï¼', 'lime');
        }
        
        setTimeout(() => {
          removeBullets(false);
          locking = false;
        }, 800);
      }, dur + 30);
    }

    // é‡æ–°å¼€å§‹
    function restart() {
      removeBullets(false);
      
      currentIndex = 0;
      currentRotation = 0;
      cylinder.style.transition = 'transform .5s ease';
      cylinder.style.transform = 'rotate(0deg)';
      
      showMessage('æ–°çš„ä¸€å±€å¼€å§‹ï¼', '#ffcc00');
    }

    // åˆå§‹åŒ–
    renderBullets();
    showMessage('è¯·æ·»åŠ å­å¼¹å¼€å§‹æ¸¸æˆ', '#ffcc00');
  </script>
</body>
</html>
